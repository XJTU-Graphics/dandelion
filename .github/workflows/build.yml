name: Dandelion-dev CI

env:
  GH_TOKEN: ${{ secrets.DANDELION_DEV }} # Needed by gh cli
  DANDELION_DEV_REPO: XJTU-Graphics/dandelion-dev
  DANDELION_DEV_TOKEN: ${{ secrets.DANDELION_DEV }}
  # We default upload only to nightly release
  # as there's a limit on artifact storage space
  UPLOAD_TO_ARTIFACT: ${{ vars.UPLOAD_TO_ARTIFACT || 'false' }}
  UPLOAD_TO_NIGHTLY: ${{ vars.UPLOAD_TO_NIGHTLY || 'true' }}

on:
  workflow_dispatch:

  pull_request:
    branches: [ main ]

jobs:
  check_dev_updated:
    runs-on: ubuntu-24.04
    outputs:
      updated: ${{ steps.check.outputs.updated }}
    steps:
      - id: check
        name: Check if dev is updated
        run: |
          LAST_NIGHTLY_HASH=$(gh release view nightly -R ${{ github.repository }} --json name --jq '.name' | cut -d "[" -f2 | cut -d "]" -f1)
          CURRENT_NIGHTLY_HASH=$(curl -s -H "Authorization: token ${{ env.DANDELION_DEV_TOKEN }}" \
            -H "Accept: application/vnd.github.VERSION.sha" \
            "https://api.github.com/repos/${{ env.DANDELION_DEV_REPO }}/commits/main")
          if [ ${LAST_NIGHTLY_HASH} = ${CURRENT_NIGHTLY_HASH} ]; then
            # is not updated
            echo "updated=false" >> "$GITHUB_OUTPUT"
          else
            echo "updated=true" >> "$GITHUB_OUTPUT"
          fi
          # update title
          gh release edit nightly -R ${{ github.repository }} --title "Nightly build [${CURRENT_NIGHTLY_HASH}]"
  build_windows_x64_msvc:
    runs-on: windows-2022
    needs: check_dev_updated
    if: ${{ needs.check_dev_updated.outputs.updated == 'true' }}
    strategy:
      matrix:
        build_kind: [dev, lib]
        build_type: [debug, release]
        include:
          - build_kind: dev
            cmake_root: .
          - build_kind: lib
            cmake_root: lib
          - should_upload: false
          - build_kind: lib
            should_upload: true
          - build_type: release
            should_upload: true
    env:
      ARTIFACT_NAME: dandelion-windows_msvc-x64-${{ matrix.build_kind }}-${{ matrix.build_type }}
    defaults:
      run:
        shell: powershell
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          repository: ${{ env.DANDELION_DEV_REPO }}
          token: ${{ env.DANDELION_DEV_TOKEN }}
      
      - name: ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ env.ARTIFACT_NAME }}
      
      - name: Generate VS build file
        run: |
          New-Item -ItemType "directory" build
          cmake -G "Visual Studio 17 2022" -S ${{ matrix.cmake_root }} -B build -D CMAKE_C_COMPILER_LAUNCHER=ccache -D CMAKE_CXX_COMPILER_LAUNCHER=ccache
      
      - name: Build Dandelion
        run: cmake --build build --config ${{ matrix.build_type }} --parallel $Env:NUMBER_OF_PROCESSORS
      
      - if: ${{ env.UPLOAD_TO_ARTIFACT == 'true' && matrix.should_upload }}
        name: Upload Artifact
        uses: actions/upload-artifact@v4
        continue-on-error: true
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ./build/${{ matrix.build_type }}/*

      - if: ${{ env.UPLOAD_TO_NIGHTLY == 'true' && matrix.should_upload }}
        name: Upload Nightly
        run: |
          7z a -tzip -mx9 ${{ env.ARTIFACT_NAME }}.zip ./build/${{ matrix.build_type }}/*
          gh release upload nightly ${{ env.ARTIFACT_NAME }}.zip -R ${{github.repository}} --clobber
        continue-on-error: true
  